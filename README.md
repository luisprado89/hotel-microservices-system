# Hotel Microservices System

Este proyecto implementa un sistema distribuido para la gesti√≥n de usuarios, reservas y comentarios en un entorno hotelero. Est√° dise√±ado siguiendo una arquitectura de microservicios utilizando **Spring Boot**, **Spring Cloud**, **Eureka**, **API Gateway**, y se apoya en bases de datos **MySQL** y **MongoDB**.

El objetivo es permitir a los usuarios registrarse, iniciar sesi√≥n, realizar reservas en hoteles, consultar informaci√≥n y dejar comentarios, todo ello de forma desacoplada, escalable y gestionada por servicios independientes.


## Arquitectura del Sistema

El sistema est√° compuesto por cinco microservicios principales:

### 1. **usuarios**

* **Descripci√≥n**: Servicio REST encargado del registro, validaci√≥n, actualizaci√≥n y eliminaci√≥n de usuarios.
* **Puerto**: 8502
* **Base de datos**: MySQL (`usuariosProyecto`)
* **Ruta ra√≠z**: `/usuarios`
* **Rutas y funcionalidades**:

## ‚úÖ `UsuarioController.java` (Controller)

Este controlador expone los endpoints REST seg√∫n lo especificado en el enunciado. Cada m√©todo del controlador delega la l√≥gica al servicio `UsuarioService`.

- Anotado con `@RestController` y `@RequestMapping("/usuarios")`.

### üìå Endpoints Implementados

| M√©todo HTTP | Ruta                                | M√©todo de Servicio             | Descripci√≥n                                                   |
|-------------|-------------------------------------|--------------------------------|---------------------------------------------------------------|
| POST        | `/usuarios/registrar`               | `crearUsuario`                 | Crea un nuevo usuario.                                        |
| PUT         | `/usuarios/registrar`               | `actualizarUsuario`            | Actualiza los datos de un usuario existente.                 |
| DELETE      | `/usuarios`                         | `eliminarUsuario`              | Elimina un usuario por nombre y contrase√±a.                   |
| POST        | `/usuarios/validar`                 | `validarUsuario`               | Valida las credenciales de un usuario.                        |
| GET         | `/usuarios/info/id/{id}`            | `obtenerInfoUsuarioPorId`      | Devuelve el nombre de un usuario dado su ID.                 |
| GET         | `/usuarios/info/nombre/{nombre}`    | `obtenerInfoUsuarioPorNombre`  | Devuelve el ID del usuario dado su nombre.                   |
| GET         | `/usuarios/checkIfExist/{id}`       | `checkIfExist`                 | Verifica si un usuario con ese ID existe en la base de datos.|

---

## üîß `UsuarioService.java` (Service)

Contiene la l√≥gica de negocio. Se encarga de manejar y procesar los datos provenientes del controlador antes de interactuar con la capa de persistencia (`UsuarioRepository`).

### M√©todos Clave

#### `crearUsuario(Usuario u)`
- Valida que los datos no sean nulos.
- Guarda el usuario con `repo.save(u)`.

#### `actualizarUsuario(Usuario u)`
- Busca el usuario por ID.
- Solo actualiza si el usuario existe.
- Modifica campos individuales y guarda los cambios.

#### `eliminarUsuario(String nombre, String contrasena)`
- Busca al usuario por nombre y contrase√±a.
- Elimina el usuario si coincide.

#### `validarUsuario(String nombre, String contrasena)`
- Verifica si existe un usuario con ese nombre y contrase√±a.
- Devuelve un booleano.

#### `obtenerInfoUsuarioPorId(Integer id)`
- Devuelve el nombre del usuario si existe.
- Si no, devuelve `"Usuario no encontrado"`.

#### `obtenerInfoUsuarioPorNombre(String nombre)`
- Devuelve el ID del usuario como `String`.

#### `checkIfExist(Integer id)`
- Devuelve `true` o `false` seg√∫n si el ID existe en la base de datos.

---
### 2. **reservas**

* **Descripci√≥n**: Servicio REST para gestionar hoteles, habitaciones y reservas. Valida al usuario mediante el microservicio `usuarios`.
* **Puerto**: 8501
* **Base de datos**: MySQL (`reservasProyecto`)
* **Ruta ra√≠z**: `/reservas`
* **Funcionalidades**:

  #### Gesti√≥n de habitaciones `/reservas/habitacion`

   * `POST` - Crear habitaci√≥n
   * `PATCH` - Actualizar habitaci√≥n
   * `DELETE /{id}` - Eliminar habitaci√≥n por ID

  #### Gesti√≥n de hoteles `/reservas/hotel`

   * `POST` - Crear hotel
   * `PATCH` - Actualizar hotel
   * `DELETE /{id}` - Eliminar hotel y sus habitaciones
   * `POST /id/{nombre}` - Obtener ID a partir del nombre
   * `POST /nombre/{id}` - Obtener nombre a partir del ID

  #### Gesti√≥n de reservas `/reservas`

   * `POST` - Crear reserva
   * `PATCH` - Cambiar estado de reserva
   * `GET` - Listar reservas del usuario
   * `GET /estado/{estado}` - Listar reservas por estado
   * `GET /check?idUsuario=&idHotel=&idReserva=` - Validar combinaci√≥n reserva
## ‚úÖ Verificaci√≥n de Endpoints del Microservicio `reservas`

| Funcionalidad                      | Ruta esperada                              | M√©todo HTTP | Implementado | Comentario                                                  |
|-----------------------------------|--------------------------------------------|-------------|--------------|-------------------------------------------------------------|
| Crear reserva                     | `/reservas`                                | POST        | ‚úÖ            | Usa `ReservaDTO` + validaci√≥n de credenciales              |
| Cambiar estado de reserva         | `/reservas`                                | PATCH       | ‚úÖ            | Usa `CambiarEstadoDTO`                                     |
| Listar reservas por usuario       | `/reservas`                                | GET         | ‚úÖ            | Requiere `UsuarioDTO` con credenciales                     |
| Listar reservas por estado        | `/reservas/{estado}`                        | GET         | ‚úÖ            | Recibe `estado` en la URL y valida credenciales            |
| Verificar reserva                 | `/reservas/check`                           | GET         | ‚úÖ            | No requiere validaci√≥n de credenciales                     |
| Crear hotel                       | `/reservas/hotel`                           | POST        | ‚úÖ            | Usa `HotelDTO` con validaci√≥n                              |
| Actualizar hotel                  | `/reservas/hotel`                           | PATCH       | ‚úÖ            | Validaci√≥n correcta, actualizaci√≥n parcial                 |
| Eliminar hotel                    | `/reservas/hotel/{id}`                      | DELETE      | ‚úÖ            | Incluye validaci√≥n y `@Transactional` para relaciones LAZY |
| Obtener ID por nombre del hotel   | `/reservas/hotel/id/{nombre}`              | POST        | ‚úÖ            | OK                                                          |
| Obtener nombre por ID del hotel   | `/reservas/hotel/nombre/{id}`              | POST        | ‚úÖ            | OK                                                          |
| Crear habitaci√≥n                  | `/reservas/habitacion`                      | POST        | ‚úÖ            | OK                                                          |
| Actualizar habitaci√≥n             | `/reservas/habitacion`                      | PATCH       | ‚úÖ            | OK                                                          |
| Eliminar habitaci√≥n               | `/reservas/habitacion/{id}`                | DELETE      | ‚úÖ            | OK                                                          |

‚úÖ **Endpoint adicional implementado**:
- `/reservas/hotel/idReserva/{idReserva}` ‚Üí Devuelve el `hotelId` asociado a una reserva espec√≠fica.
- **Uso previsto**: integraci√≥n con el microservicio `comentarios` para validaci√≥n cruzada.
- **Comentario**: Este endpoint extra es una mejora funcional que aporta valor al sistema.


### 3. **comentarios**

* **Descripci√≥n**: Servicio GraphQL que permite a los usuarios dejar comentarios sobre hoteles.
* **Puerto**: 8503
* **Base de datos**: MongoDB (`comentariosProyecto`)
* **Endpoint GraphQL**: `/comentarios`
* **Consola GraphiQL**: habilitada en `/graphiql`
* **Colecci√≥n**: `comentarios`
## Usuario y Contrase√±a

En este proyecto, todas las funcionalidades que requieren autenticaci√≥n solicitan al usuario su nombre de usuario y contrase√±a. Estas credenciales son validadas a trav√©s del microservicio **usuarios**, que verifica su autenticidad. Si la validaci√≥n es exitosa, el sistema permite que el usuario realice la operaci√≥n solicitada.

---

## Informaci√≥n Recibida e Informaci√≥n Almacenada

Las operaciones en el sistema reciben par√°metros como **nombres** (por ejemplo, el nombre de un hotel o un usuario). Sin embargo, algunos datos, como las **puntuaciones** de los comentarios y el **ID de las reservas**, son num√©ricos.

### Conversi√≥n de nombres a identificadores

Los nombres de hoteles y usuarios recibidos en las consultas se convierten a sus respectivos **identificadores** antes de ser almacenados en la base de datos. Para esto, se realizan llamadas a los microservicios correspondientes para obtener los **IDs** necesarios, asegurando que, aunque las interacciones sean a trav√©s de nombres legibles, internamente se manejen los identificadores √∫nicos que el sistema requiere.

#### Funcionalidades:

* `crearComentario`: Crea y almacena un comentario. Valida usuario, hotel y reserva. Impide duplicados.

* `eliminarComentarios`: Elimina todos los comentarios. No requiere autenticaci√≥n.

* `eliminarComentarioDeUsuario`: Elimina un comentario de un usuario autenticado.

* `listarComentariosHotel`: Lista todos los comentarios sobre un hotel.

* `listarComentariosUsuario`: Lista todos los comentarios hechos por un usuario.

* `mostrarComentarioUsuarioReserva`: Muestra el comentario de un usuario en una reserva espec√≠fica.

* `puntuacionMediaHotel`: Muestra la puntuaci√≥n media de un hotel.

* `puntuacionesMediasUsuario`: Muestra la puntuaci√≥n media de un usuario.

* **Consultas GraphQL (Query)**:

   * `listarComentariosUsuario(nombreUsuario, contrasena)`
   * `listarComentariosHotel(nombreHotel, nombreUsuario, contrasena)`
   * `mostrarComentarioUsuarioReserva(nombreUsuario, contrasena, reservaId)`
   * `puntuacionMediaHotel(nombreHotel, nombreUsuario, contrasena)`
   * `puntuacionesMediasUsuario(nombreUsuario, contrasena)`

* **Mutaciones GraphQL (Mutation)**:

   * `crearComentario(input: ComentarioInput)`
   * `eliminarComentarios`
   * `eliminarComentarioDeUsuario(input: EliminarComentarioInput)`

* **Esquema GraphQL**:

```graphql
# Tipo de dato que representa la respuesta cuando se devuelve un comentario.
type ComentarioResponse {
  nombreHotel: String
  reservaId: Int
  puntuacion: Float
  comentario: String
}

# Entrada para crear un nuevo comentario.
input ComentarioInput {
  nombreUsuario: String!
  contrasena: String!
  nombreHotel: String!
  reservaId: Int!
  puntuacion: Float!
  comentario: String!
}

# Consultas que se pueden hacer al sistema.
type Query {
  listarComentariosUsuario(nombreUsuario: String!, contrasena: String!): [ComentarioResponse]
  listarComentariosHotel(nombreHotel: String!, nombreUsuario: String!, contrasena: String!): [ComentarioResponse]
  mostrarComentarioUsuarioReserva(nombreUsuario: String!, contrasena: String!, reservaId: Int!): [ComentarioResponse]
  puntuacionMediaHotel(nombreHotel: String!, nombreUsuario: String!, contrasena: String!): Float
  puntuacionesMediasUsuario(nombreUsuario: String!, contrasena: String!): Float
}

# Mutaciones que permiten modificar los datos.
type Mutation {
  crearComentario(input: ComentarioInput!): ComentarioResponse
  eliminarComentarios: String
  eliminarComentarioDeUsuario(input: EliminarComentarioInput!): String
}

# Entrada para eliminar un comentario validando al usuario.
input EliminarComentarioInput {
  id: ID!
  nombreUsuario: String!
  contrasena: String!
}
```
# An√°lisis Detallado del Microservicio "Comentarios"

## Paquete Principal: `com.hotel.comentarios`

### 1. `ComentariosApplication.java`
- **Tipo**: Clase principal con `@SpringBootApplication`.
- **Responsabilidad**:
  - Inicia la aplicaci√≥n Spring Boot.
  - Declara un `@Bean` de tipo `RestTemplate` que se usar√° para hacer peticiones HTTP a los otros microservicios (usuarios y reservas).
- **Clave**: Sin `RestTemplate` no se podr√≠an validar usuarios ni verificar reservas.

---

## Paquete `dto` (Data Transfer Objects)

### 2. `ComentarioInput.java`
- **Tipo**: DTO de entrada.
- **Responsabilidad**:
  - Representa los datos necesarios para crear un comentario: usuario, contrase√±a, hotel, reserva, puntuaci√≥n, texto.
- **Usado en**: `ComentarioMutation.crearComentario(...)`.

### 3. `ComentarioResponse.java`
- **Tipo**: DTO de salida.
- **Responsabilidad**:
  - Devuelve al cliente datos amigables: nombre del hotel, `reservaId`, puntuaci√≥n y comentario.
- **Usado en**: Todas las `Query` y la `Mutation` de creaci√≥n.

### 4. `EliminarComentarioInput.java`
- **Tipo**: DTO de entrada.
- **Responsabilidad**:
  - Usado para validar la eliminaci√≥n de un comentario autenticando al usuario (requiere ID del comentario, usuario y contrase√±a).
- **Usado en**: `ComentarioMutation.eliminarComentarioDeUsuario(...)`.

---

## Paquete `model`

### 5. `Comentario.java`
- **Tipo**: Modelo de documento de MongoDB (`@Document`).
- **Responsabilidad**:
  - Representa c√≥mo se guarda el comentario en la colecci√≥n `comentarios` en MongoDB.
  - Contiene los campos: `usuarioId`, `hotelId`, `reservaId`, `puntuacion`, `comentario`, y `fechaCreacion` (de tipo `Instant` para MongoDB).

---

## Paquete `repository`

### 6. `ComentarioRepository.java`
- **Tipo**: `MongoRepository`.
- **Responsabilidad**:
  - Permite acceder y manipular la colecci√≥n `comentarios`.
- **M√©todos personalizados**:
  - `existsByUsuarioIdAndHotelIdAndReservaId(...)`: Evita comentarios duplicados.
  - `findByHotelId(...)`, `findByUsuarioId(...)`: Para b√∫squedas por hotel o usuario.
  - `findByUsuarioIdAndHotelIdAndReservaId(...)`: Obtener un comentario √∫nico.

---

## Paquete `service`

### 7. `ComentarioService.java`
- **Tipo**: Servicio principal.
- **Responsabilidad**:
  - Implementa toda la l√≥gica de negocio:
    - **Validaci√≥n de usuario** (`obtenerUsuarioId`).
    - **Validaci√≥n de hotel** (`obtenerHotelId`).
    - **Validaci√≥n de reserva** (`checkReserva`).
    - **Creaci√≥n de comentario** con prevenci√≥n de duplicados.
    - **Eliminaci√≥n total o individual** de comentarios (autenticaci√≥n requerida).
    - Consultas: comentarios por usuario, hotel, reserva, medias por usuario y hotel.
- **Comunicaci√≥n con otros microservicios**:
  - Usa `RestTemplate` para comunicarse con:
    - **Microservicio de usuarios** (validar credenciales, obtener ID).
    - **Microservicio de reservas** (obtener ID o nombre de hotel, validar reserva).

---

## Paquete `resolver`

### 8. `ComentarioQuery.java`
- **Tipo**: Resolver de consultas (GraphQL).
- **Responsabilidad**:
  - Expone las siguientes `QueryMapping`:
    - `listarComentariosUsuario(...)`
    - `listarComentariosHotel(...)`
    - `mostrarComentarioUsuarioReserva(...)`
    - `puntuacionMediaHotel(...)`
    - `puntuacionesMediasUsuario(...)`
  - Llama a m√©todos del servicio que internamente validan al usuario y extraen la informaci√≥n.

### 9. `ComentarioMutation.java`
- **Tipo**: Resolver de mutaciones (GraphQL).
- **Responsabilidad**:
  - Expone las siguientes `MutationMapping`:
    - `crearComentario(...)`
    - `eliminarComentarios()`
    - `eliminarComentarioDeUsuario(...)`
  - Llama a los m√©todos de servicio para validar, crear y eliminar comentarios.

---

## Comunicaci√≥n entre Microservicios

Este microservicio no funciona de forma aislada. Se comunica con otros microservicios para validar y consultar informaci√≥n:

| Servicio Destino | Endpoint Llamado                                       | Prop√≥sito                                                   |
|-------------------|--------------------------------------------------------|-------------------------------------------------------------|
| **Usuarios**      | `/validar`, `/info/nombre/{nombre}`                    | Validar credenciales y obtener ID del usuario               |
| **Reservas**      | `/hotel/id/{nombre}`, `/hotel/nombre/{id}`, `/check`, `/hotel/idReserva/{idReserva}` | Validar hotel, obtener nombre/ID, comprobar reservas        |

---

Este documento describe la estructura y funcionamiento del microservicio de comentarios, incluyendo las clases clave, m√©todos de interacci√≥n y la comunicaci√≥n con otros microservicios esenciales para su funcionamiento.

### 4. **eureka-server**

* **Descripci√≥n**: Servidor Eureka para registro y descubrimiento de microservicios.
* **Puerto**: 8500
* **Interfaz Web**: `http://localhost:8500`

### 5. **gateway**

* **Descripci√≥n**: API Gateway con Spring Cloud Gateway que enruta peticiones REST y GraphQL.
* **Puerto**: 8080
* **Funcionalidades**:

   * Ruteo completo hacia `/usuarios`, `/reservas`, `/comentarios`
   * Soporte para `/graphiql` a trav√©s de redirecci√≥n y encabezados
   - **Ejemplos**:
      - `http://localhost:8080/usuarios`
      - `http://localhost:8080/reservas`
      - `http://localhost:8080/comentarios`
---

## Tecnolog√≠as utilizadas

* Spring Boot
* Spring Cloud (Eureka, Gateway)
* Maven multi-m√≥dulo
* MySQL y MongoDB
* GraphQL / GraphiQL
* Postman (para pruebas manuales)


---


---
# üìù Evaluaci√≥n de Servicios (Escalado a 10 puntos)

> Todas las funcionalidades est√°n implementadas en el proyecto (‚úîÔ∏è).  
> Las puntuaciones han sido escaladas correctamente (factor de escala: **2.5**).

| Funcionalidad                      | Servicio            | Estado | Puntos |
|-----------------------------------|---------------------|--------|--------|
| Cumple todas las especificaciones | Comentarios         | ‚úîÔ∏è     | 0.375  |
| crearComentario                   | Comentarios         | ‚úîÔ∏è     | 0.25   |
| eliminarComentarios               | Comentarios         | ‚úîÔ∏è     | 0.25   |
| eliminarComentarioDeUsuario       | Comentarios         | ‚úîÔ∏è     | 0.375  |
| listarComentariosHotel            | Comentarios         | ‚úîÔ∏è     | 0.5    |
| listarComentariosUsuario          | Comentarios         | ‚úîÔ∏è     | 0.5    |
| mostrarComentarioUsuarioReserva   | Comentarios         | ‚úîÔ∏è     | 0.5    |
| puntuacionMediaHotel              | Comentarios         | ‚úîÔ∏è     | 0.5    |
| puntuacionesMediasUsuario         | Comentarios         | ‚úîÔ∏è     | 0.5    |
| **Subtotal Comentarios**          |                     |        | **3.75** |
| Cumple todas las especificaciones | Usuario             | ‚úîÔ∏è     | 0.375  |
| crearUsuario                      | Usuario             | ‚úîÔ∏è     | 0.25   |
| actualizarUsuario                 | Usuario             | ‚úîÔ∏è     | 0.25   |
| eliminarUsuario                   | Usuario             | ‚úîÔ∏è     | 0.25   |
| validarUsuario                    | Usuario             | ‚úîÔ∏è     | 0.25   |
| obtenerInfoUsuarioPorId           | Usuario             | ‚úîÔ∏è     | 0.25   |
| obtenerInfoUsuarioPorNombre       | Usuario             | ‚úîÔ∏è     | 0.25   |
| checkIfExist                      | Usuario             | ‚úîÔ∏è     | 0.25   |
| **Subtotal Usuario**              |                     |        | **2.125** |
| Cumple todas las especificaciones | Reservas            | ‚úîÔ∏è     | 0.25   |
| crearHabitaci√≥n                   | Reservas            | ‚úîÔ∏è     | 0.125  |
| actualizarHabitacion              | Reservas            | ‚úîÔ∏è     | 0.125  |
| eliminarHabitacion                | Reservas            | ‚úîÔ∏è     | 0.125  |
| crearHotel                        | Reservas            | ‚úîÔ∏è     | 0.125  |
| actualizarHotel                   | Reservas            | ‚úîÔ∏è     | 0.125  |
| eliminarHotel                     | Reservas            | ‚úîÔ∏è     | 0.125  |
| obtenerIdApartirNombre            | Reservas            | ‚úîÔ∏è     | 0.375  |
| obtenerNombreAPartirId            | Reservas            | ‚úîÔ∏è     | 0.375  |
| crearReserva                      | Reservas            | ‚úîÔ∏è     | 0.125  |
| cambiarEstado                     | Reservas            | ‚úîÔ∏è     | 0.125  |
| listarReservasUsuario             | Reservas            | ‚úîÔ∏è     | 0.375  |
| listarReservasSegunEstado         | Reservas            | ‚úîÔ∏è     | 0.375  |
| checkReserva                      | Reservas            | ‚úîÔ∏è     | 0.375  |
| **Subtotal Reservas**             |                     |        | **3.125** |
| Eureka Server y Client            | Infraestructura     | ‚úîÔ∏è     | 0.5    |
| API Gateway                       | Infraestructura     | ‚úîÔ∏è     | 0.5    |
| **TOTAL GENERAL**                 |                     |        | **10.0** |
